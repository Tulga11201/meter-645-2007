#include "MyIncludesAll.h"
#undef Debug_Print
#define Debug_Print(...)
//#define Debug_Print _Debug_Print

//----------------------------------------------------------------------------------
//----------------------------------------------------------------------------------
//"更新是否更新标志//
//"位	  //
//"Bit0	费率表第一套 //
//"Bit1	费率表第二套 //
//"Bit2	保留 //
//"Bit3	保留 //
//"Bit4	保留 //
//"Bit5	保留 //
//"Bit6	保留 //
//"Bit7	其他参数 //
//----------------------------------------------------------------------------------
//----------------------------------------------------------------------------------
//" 开户卡,购电卡，比较合法性//  Buy_Count 为cpu卡的购电次数
unsigned char Judge_User_Card_OK(unsigned char BuyCard_Kind,unsigned long Buy_Count){
	unsigned long Money_Count_T;// 用来比较 
        INT8U MeterIDTemp[6];
	struct Buy_Para_Inf_File file;// 参数信息文件结构体
	//struct Moneybag_Data Moneybag_Data;//钱包文件结构体  4+4个字节
	//从esam 读取 钱包文件,读出来后反相
	//Read_Esam_Moneybag_File((unsigned char *)&Moneybag_Data);
	//Pre_Payment_Para.Buy_Count为黄工管理的当前电表购电次数
        
	Money_Count_T = Pre_Payment_Para.Buy_Count+1;//用来比较次数是否大1
         Debug_Print(" 开始执行函数：Judge_User_Card_OK(unsigned char BuyCard_Kind,unsigned long Buy_Count) " );
        String2ParaFile(  &file,&Card_WR_Buff[4], sizeof(struct Buy_Para_Inf_File) );
         Debug_Print("//判断是否购电卡类型错// " );
	if( BuyCard_Kind !=GWFAR_USER_CARD_NEW && BuyCard_Kind !=GWFAR_USER_CARD_BUY && BuyCard_Kind !=GWFAR_USER_CARD_BACK)
		{
		Card_Error_State.CardErrorState.BUY_CARD_KIND_ERR=1;
	 	return ERR;
		}
	 Debug_Print("//判断表号 // " );
        My_memcpyRev(MeterIDTemp,(unsigned char *)&Pre_Payment_Para.BcdMeterID[0],6);
	if( My_Memcmp(&(file.Meter_ID[0]),MeterIDTemp,6) ){
		Card_Error_State.CardErrorState.MeterIdErr=1;
		return ERR;
	}
         Debug_Print(" //只要表计状态为运行状态，则必须比较用户号// " );
	if(  Pre_Payment_Para.Meter_Run_State  EQ MeterRunState_Run_3 ){
                Debug_Print(" // 判断是否用户编号不对// " );
		if( My_Memcmp(Pre_Payment_Para.UserID,file.Client_ID,6) )
			{
			  Card_Error_State.CardErrorState.CardIdErr=1;
			  return ERR;
			}
                 Debug_Print( "//如果购电次数相等则直接回写// " );
  
		if( My_Memcmp((unsigned char *)&Buy_Count, (unsigned char *)&Pre_Payment_Para.Buy_Count,4) ==0 ) {
			Dir_Return_Flag = 0xFF; Debug_Print("//标示购电次数相等时直接 返写cpu卡   " );
			return OK;
		 }
                 Debug_Print("//如果是运行状态插入 开户卡， 计入非法卡插入次数 " );
		if( BuyCard_Kind ==GWFAR_USER_CARD_NEW ){
			Card_Error_State.CardErrorState.BUY_CARD_KIND_ERR=1;
			return ERR;
		 }
	} //运行状态判断结束
	else{
                Debug_Print("// 判断是否未开户状态插入购电卡，补卡  " );
		if( BuyCard_Kind !=GWFAR_USER_CARD_NEW )
			{
			 Card_Error_State.CardErrorState.CARD_STATE_ERR=1;
			 return ERR;
			}
		else
			{
                         Debug_Print("判断是否已经回写过的新卡，那么不能重复开户// " );
                        //"已经回写过的新卡不能重复开户//
			CPU_ESAM_CARD_Control(CPU);
			Read(0,Read_Binary,0x80+5,0,1);
			CPU_ESAM_CARD_Control(ESAM);
			if( receive_send_buffer[0] == 0x68 )
				{
				  Card_Error_State.CardErrorState.CPU_NEW_CARD_INI_ERR=1;
				  return ERR;
				}
			}
	}//正式运行和非正式运行状态的判断结束
         Debug_Print("// 判断是否购电次数错//   购电次数必须符合：cpu卡的购电次数 与 esam 的 +1后购电次数 相等 " );
        
	if( My_Memcmp((unsigned char *)&Buy_Count,(unsigned char *)&Money_Count_T,4) !=0){
		Card_Error_State.CardErrorState.CARD_BUY_COUNT_ERR=1;
	 	return ERR;
	}
         Debug_Print(" //判断是否离散因子错了 " );
	if( BuyCard_Kind == GWFAR_USER_CARD_BUY )
		{
		 if( My_Memcmp(Pre_Payment_Para.Cpucard_Number_old_BackUpInEerom, cpucard_number, 8) ){
			   Card_Error_State.CardErrorState.Cpu_Card_Li_San_Yin_Zi_Err=1 ;//卡错误。离散因子错了,有补卡更新了离散因子
		 	   return ERR;
		}
	}
         Debug_Print(" 结束执行函数：Judge_User_Card_OK(unsigned char BuyCard_Kind,unsigned long Buy_Count) " );
	return OK;
}
//----------------------------------------------------------------------------------
//----------------------------------------------------------------------------------
//"判断本次购电的囤积门限//

unsigned char Judge_Remain_Money_Over(INT32U Curr_Buy_Money) {
	INT32U  Money_Count_T,Money_Count_T1;
        
        //判断是否购电费用超额
	Money_Count_T = Pre_Payment_Para.Remain_Money;
	Money_Count_T+=Curr_Buy_Money;
        //
	Money_Count_T1 = Pre_Payment_Para.Remain_Money_Hoard_Limit;
        //Money_Count_T1 = (signed long)DataTemp;
	if( Money_Count_T1 != 0 ){
		if( Money_Count_T > Money_Count_T1 )
                {
                  return ERR;
                }	
	}
	//" 剩余电费大于2千万也不允许进表 //
	if( Money_Count_T > 0x77359400 )  //不知道要不要
        {
           return ERR;
        }
	return OK;
	}
//----------------------------------------------------------------------------------
//----------------------------------------------------------------------------------
//"开户卡,购电卡//
unsigned char Buy_Card(void){
	unsigned char Buy_Card_Kind;//用户卡类型，购电卡， 开户卡， 补卡
        INT8U UserID[6];//客户编号
	struct Moneybag_Data Moneybag_Data;
	struct Buy_Para_Inf_File  file;
        
        String2ParaFile(&file,(&Card_WR_Buff[4]), sizeof(struct Buy_Para_Inf_File) )  ;//初始化file变量
        Debug_Print("//  读CPU卡中的剩余电费和购电次数 //02  0 读出来，但是会把 cpu卡中的数据反转，即高位在低位，cpu卡中数据时反得1 " );
	if( Remain_Money_Moneybag_Add(USER_CARD_MONEYBAG_FILE,REMAIN_MONEY_CPU_ESAM,(unsigned char *)&Moneybag_Data) != OK )
		return ERR;
         
	//file=(struct Buy_Para_Inf_File *)(&Card_WR_Buff[4]);
	
	if( Cpucard_External_Auth() != OK )
		return ERR;
        Debug_Print("//  正确  // " );
	Buy_Card_Kind = file.Card_Kind;//
	
	
	if( Judge_User_Card_OK( Buy_Card_Kind ,Moneybag_Data.Buy_Count) != OK )
		return ERR;
        Debug_Print("//   卡的合法条件满足  // " );
       My_Memcpy(UserID,file.Client_ID,6);
       //如果为开户卡，或者编程按钮被按下 
       //Meter_Ins_Flag = 0xFF;
       if( (Buy_Card_Kind == GWFAR_USER_CARD_NEW) || Check_Meter_Prog_Status() ){  
                        Debug_Print("  //如果为开户 f1卡，或者编程按钮被按下 开始进入相应流程 " );
			Para_Updata_Flag = file.Para_UpData_Flag;
                        Debug_Print("//  参数信息文件处理 // " );
			if( Para_Updata_Flag & 0x80 ){
                                //读取cpu卡参数信息文件前面两个字节
				if( Esam_File_Updata( USER_CARD_PARA_INF_FILE,//01
										ESAM_PARA_INF_FILE,//2
										BUY_PARA_INF_FILE_BUY_CARD,//4
										ESAM_PARA_INF_FILE_ESAM,//4
										2,
										Card_WR_Buff+BUY_PARA_INF_FILE_BUY_CARD) != OK )//+4
					return ERR;
                                Debug_Print(" //读取cpu卡参数信息文件从报警金额1后不包含身份验证时效的  全部数据到esam卡  " );
                               
				if( Esam_File_Updata(USER_CARD_PARA_INF_FILE,//
										ESAM_PARA_INF_FILE,//
										REMAIN_MONEY_ALARM1_LIMIT_BUY_CARD,//
										REMAIN_MONEY_ALARM1_LIMIT_ESAM,//
										27,
										Card_WR_Buff+REMAIN_MONEY_ALARM1_LIMIT_BUY_CARD) != OK )
					return ERR;
			}
			if( Para_Updata_Flag & 0x02 ){
				if( Esam_File_Updata(USER_CARD_PARA_INF_FILE,////1
										ESAM_PARA_INF_FILE,///2
										TRIFF_SWITCH_TIME_BUY_CARD,
										TRIFF_SWITCH_TIME_ESAM,
										5,
										Card_WR_Buff+TRIFF_SWITCH_TIME_BUY_CARD) != OK )
					return ERR;
			}
                        Debug_Print("这个地方肯能有问题， 应该把从cpu卡中的数据告诉黄工   " );
                        //
			//  第一套费率表文件 //
			if( Para_Updata_Flag & 0x01 ){
				if( Esam_File_Updata(USER_CARD_TRIFF_1_FILE,//3
										ESAM_TRIFF_1_FILE,//3
										0,
										0,
										240,
										Card_WR_Buff) !=OK )
					return ERR;
				if( Esam_File_Updata(USER_CARD_TRIFF_1_FILE,//3
										ESAM_TRIFF_1_FILE,//4
										240,
										240,
										18,
										Card_WR_Buff+240) !=OK )
					return ERR;
				Deal_Triff_Data(Card_WR_Buff+4,258-4,1);//这个地方可能有错误，从cpu卡读出来的数据太长了
			}
                        Debug_Print("//  第二套费率表文件 //   " );
			
			if( Para_Updata_Flag & 0x02 ){
				if( Esam_File_Updata(USER_CARD_TRIFF_2_FILE,//4
										ESAM_TRIFF_2_FILE,//4
										0,
										0,
										240,
										Card_WR_Buff) !=OK )
					return ERR;
				if( Esam_File_Updata(USER_CARD_TRIFF_2_FILE,
										ESAM_TRIFF_2_FILE,
										240,
										240,
										18,
										Card_WR_Buff+240) !=OK )
					return ERR;
				Deal_Triff_Data(Card_WR_Buff+4,258-4,2);// 129//这个地方可能有错误，从cpu卡读出来的数据太长了
			}
          
	}  
       Debug_Print(" //如果是非新卡，且 购电次数相等，Dir_Return_Flag被赋值0xff  " );
	if( Dir_Return_Flag==0 ){//如果是非新卡，且 购电次数相等，Dir_Return_Flag被赋值0xff
		 Debug_Print("  // 判断本次购电的囤积门限  //  " );
                 // 判断本次购电的囤积门限  //
		if( Judge_Remain_Money_Over( Moneybag_Data.Remain_Money ) != OK ){//Moneybag_Data.Remain_Money来自cpu卡
			   Card_Error_State.CardErrorState.MoneyLimitErr=1;
			   return ERR;
		}
		//  ESAM钱包文件充值  //不更新购电次数？？？？//2,0,0
                
		if(Remain_Money_Moneybag_Add(USER_CARD_MONEYBAG_FILE,REMAIN_MONEY_CPU_ESAM,0)!=OK)
		//	return ERR;
                test();//在这里应该加入 更新esam 购电次数的函数
                Debug_Print("///告诉黄工，充值了，充了多少钱，同事更新我定义的变量   " );
		//告诉黄工，充值了，充了多少钱，同事更新我定义的变量
		Meter_Money_And_Count_Updata(Moneybag_Data.Remain_Money,Moneybag_Data.Buy_Count );
                Debug_Print(" // 新卡保存用户号和变更表计运行状态 //  " ); 
		// 新卡保存用户号和变更表计运行状态 //
		if( Buy_Card_Kind== GWFAR_USER_CARD_NEW ){
                        Debug_Print("  / 新卡保存用户号和变更表计运行状态 // " );
			My_Memcpy(Pre_Payment_Para.UserID,UserID,6);
		    	Write_Storage_Data(SDI_CUTOMER_ID,&Pre_Payment_Para.UserID, 6);
                        
			Pre_Payment_Para.Meter_Run_State=MeterRunState_Run_3 ;
                        Write_Storage_Data(_SDI_PREPAID_RUN_STATUS,&Pre_Payment_Para.Meter_Run_State, 1);
		}
	} /*
        Meter_Ins_Flag = 0x00;
        //test();
        Debug_Print("更新esam参数信息文件  1 " ); 
	if( Esam_File_Updata(USER_CARD_PARA_INF_FILE,//1
								ESAM_PARA_INF_FILE,//2
								CLIENT_ID_BUY_CARD,
								CLIENT_ID_ESAM,
								6,
								Card_WR_Buff+CLIENT_ID_BUY_CARD) != OK )
			return ERR;
         Debug_Print("  更新esam参数信息文件2 " );
	if( Esam_File_Updata(USER_CARD_PARA_INF_FILE,
								ESAM_PARA_INF_FILE,
								USER_KIND_BUY_CARD,
								USER_KIND_ESAM,
								2,
								Card_WR_Buff+USER_KIND_BUY_CARD) != OK )
			return ERR;
          Debug_Print(" 更新esam参数信息文件 3  " );
        */
	if( Buy_Card_Kind != GWFAR_USER_CARD_BUY )//开户卡， 和补卡更新 离散因子
			{
                          Debug_Print("//开户卡， 和补卡更新 离散因子   " );
			My_Memcpy(Pre_Payment_Para.Cpucard_Number_old_BackUpInEerom, cpucard_number, 8);
                        
			 Write_Storage_Data(_SDI_DISCRETE_INFO ,&Pre_Payment_Para.Cpucard_Number_old_BackUpInEerom,  8);
                        }
        
        // 回写文件处理 //
        Debug_Print("  回写文件处理 //  " );
        test();//0x11是干啥的？
        //cpu卡的运行信息文件和esam的运行信息文件结构和顺序都是一致的，但是这个两个文件的短标示是不一样的卡中的为5，esam中的7
        //读esam 的返写信息文件到cpu卡中  ，应为实际上是读esam的运行信息文件之前， 先更新esam运行信息文件
	if( Updata_Esam_Return_File(0x11)!=OK )  
		return ERR;
        //这里也可以说是读esam 的运行信息文件到cpu卡中运行信息文件中 
         Debug_Print("读esam 的返写信息文件到cpu卡中 ， 先更新esam参数信息文件   " );       //5, 7
	if( Cpu_File_Updata(USER_CARD_RUN_INF_FILE,ESAM_RUN_INF_FILE,0,0,LENGTH_RUN_INF_DATA+6) != OK )
		return ERR;
        Debug_Print("购电卡执行结束   " );
	return OK;
}

////////////费率文件更新:SrcLen值为：总文件长减去4(68到16结尾)  WhichTable:1表示第一套费率， 2表示第二套费率
void Deal_Triff_Data(unsigned char * Source_Point,unsigned char SrcLen,INT8U WhichTable){
        Debug_Print("这个地方调黄工给我的函数  ,更新黄工的费率数据 " );
        //  这个地方调黄工给我的函数  ,更新黄工的费率数据
        INT8U j;
	struct Triff_Data Triff_Data;
        INT32U Temp=SDI_RATE_SCHEME0_0;
        if(SrcLen<sizeof(struct Triff_Data))
        {
            ASSERT_FAILED();
        }
        mem_cpy(&Triff_Data,Source_Point,sizeof( struct Triff_Data),&Triff_Data,sizeof(struct Triff_Data) );
        //判断是那一套费率
        Debug_Print("判断是那一套费率 " );
        if(1 EQ WhichTable){
              Temp=SDI_RATE_SCHEME0_0;
        }else if(2 EQ WhichTable){
              Temp=SDI_RATE_SCHEME1_0;
        }else{
             ASSERT_FAILED();
        }
        Debug_Print("//把费率反相后 写到e方中取， 由黄工解释 " );
        //把费率反相后 写到e方中取， 由黄工解释
        if(MAX_RATES <= ( sizeof(struct Triff_Data)/4 ) ){
        	for( j=0;j<MAX_RATES;j++ ){
		   Reverse_data((unsigned char *)&(Triff_Data.Triff[j]),4);
                   Write_Storage_Data(Temp+j, (unsigned char *)&(Triff_Data.Triff[j]), 4);
	        }
        }else{
             ASSERT_FAILED();
        }
}


//告诉黄工，充值了，充了多少钱，同事更新我定义的变量
//Curr_Buy_Money 当前充值费用,unsigned long Curr_Buy_Money_Count 当前cpu卡中的
void Meter_Money_And_Count_Updata( unsigned long Curr_Buy_Money,unsigned long Curr_Buy_Money_Count )
	{
          
          //告诉黄工 充了多少电，
          Prepaid_Buy_Money_Proc (Curr_Buy_Money);
          //更新我管理的全局变量
        }
//////////////
void Deal_Buy_Para_Inf_File(unsigned char * Source_Point ){
	/*unsigned char i;
	struct Buy_Para_Inf_File *Buy_Para_Inf_File;
  
	Buy_Para_Inf_File = (struct Buy_Para_Inf_File *)Source_Point;
        
	//Deal_Para_Table2((unsigned char *)&(Buy_Para_Inf_File->User_Kind),Mode);
	//Deal_Para_Table4((unsigned char *)&(Buy_Para_Inf_File->Triff_Switch_Time),Mode);
	//Deal_Para_Table3((unsigned char *)&(Buy_Para_Inf_File->Remain_Money_Alarm1_Limit),Mode);
	//Deal_Para_Table1((unsigned char *)&(Buy_Para_Inf_File->Meter_ID),Mode);
	*/

}

        //SDI_RATE_SCHE_CHG_TIME
///////////
INT8U test(void){return 1;}
